#!/bin/sh

# Record an X window with ffmpeg

# Globals
out_file=
frame_rate=25
pixel_border=0
out_dir=

usage () {
cat <<END
Usage: $0 [-h]
          [-f FRAME_RATE] [-p NUM_PIXELS ] OUT_FILE
   -h: display this help message and exit.
   -f: set video framerate.
   -p: set border pixel of the selected window.

   OUT_FILE: output file.
END
   exit 1
}

die () {
   printf '%s: %s.\n' "$0" "$*" >&2
   exit 1
}

requires () {
   {
      for cmd in "$@" ; do
         command -v "$cmd" || die "$cmd: command not found"
      done
   } >/dev/null
}

is_digit () {
   expr "$2" : '[0-9]\+$' >/dev/null || die "'$1' must be a digit"
}

parse_args () {

   while test $# -gt 0 ; do
      case $1 in
         -h)
            usage
            ;;
         -f)
            test $# -lt 2 && usage
            is_digit framerate "$2"
            frame_rate=$2
            ;;
         -p)
            test $# -lt 2 && usage
            is_digit "border_pixel" "$2"
            pixel_border=$2
            ;;
         -*)
            die "Unknown option \`$1'"
            ;;
          *)
            test $# -gt 1 && usage
            out_file=$1
            ;;
      esac
      shift 2
   done

   if test -z "$out_file" ; then
      die "You must set an output file"
      usage
   fi

   out_dir=${out_file%/*}

   mkdir -p "$out_dir" || exit 1
   test -w "$out_dir"  || die "cannot write to \`$out_dir'"
}

record () {
   ff_opts=$(
      xwininfo | awk -v pixel_border="$pixel_border" '
         /Height:/ { h = substr($0, 11) }
         /Width:/  { w = substr($0, 10) }
         /^[\t ]*A.* X:/ { x = substr($0, 27) }
         /^[\t ]*A.* Y:/ { y = substr($0, 27) }
         END {
            if (pixel_border) {
               x -= pixel_border
               y -= pixel_border
               w += (2 * pixel_border)
               h += (2 * pixel_border)
            }
            print "-video_size " w "x" h " -i :0.0+" x "," y
         }
      '
   )

   eval ffmpeg                   \
         -hide_banner             \
         -f x11grab                \
         -framerate $frame_rate     \
         $ff_opts                    \
         -pix_fmt rgba                \
         -qp 0                         \
         -preset ultrafast              \
         -y "'$out_file'"
}

main () {
   requires xwininfo ffmpeg herbe
   parse_args "$@"
   record
}

main "$@"
