#!/bin/sh

die () {
   printf "%s: %s." "$0" "$*" >&2
   exit 1
}

requires () {
   for cmd in "$@" ; do
      command -v $cmd >/dev/null || die "$cmd: command not found"
   done
}

msearch () {
   cache="${XDG_HOME_CACHE:-"$HOME/.cache"}"
   mcache="${cache}/msearch"

   sfile=
   vfiles=
   dmenu='dmenu -c -p "Select" -z 600 -l 10 -h 20 -i'

   dirs=$(stest -dr -n "$mcache" "$@" | sed -e 's/^/"/;s/$/"/')

   if test -n "$dirs" ; then
      vfiles=$(eval find "$dirs" -type f -exec file --mime-type '"{}"' '\;' | sed -ne 's#^\(.\+\): video/.\+$#\1#p')

      test -z "$vfiles" && return
      sfile=$(printf '%s\n' "$vfiles" | tee -a "$mcache" | eval "$dmenu")
   else
      sfile=$(cat "$mcache" | eval "$dmenu")
   fi

   test -n "$sfile" && exec ffplay -loop 0 "$sfile"
}

requires file stest ffplay
msearch "$HOME/Download" "$HOME/Videos"
